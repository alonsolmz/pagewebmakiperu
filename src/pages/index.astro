---
export const prerender = false;

import Layout from '../layouts/Layout.astro'; // Ajusta la ruta si usas @
import { supabase } from '../lib/supabase';
import { Image } from 'astro:assets';

// 1. Obtenemos TODOS los vehículos para la lista principal
const { data: vehiculos, error } = await supabase
  .from('vehiculos')
  .select('*')
  .order('created_at', { ascending: false });

// 2. Manejo de error amigable (SIN REDIRECT)
const hayError = !!error;
const listaVehiculos = vehiculos || [];
---

<Layout title="MaquiPeru - Catálogo">
  <main style="font-family: sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto;">
    <header style="text-align: center; margin-bottom: 40px;">
      <h1 style="font-size: 3rem; margin-bottom: 10px;">MAQUIPERU</h1>
      <p style="color: #666;">Catálogo de Maquinaria Pesada</p>
    </header>

    {hayError && (
      <div style="background: #fee2e2; color: #b91c1c; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
        <strong>Error de conexión:</strong> {error.message}. 
        <br/>Revisa las variables de entorno en Vercel.
      </div>
    )}

    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px;">
      {listaVehiculos.map((v) => (
        <a href={`/vehiculo/${v.id}`} style="text-decoration: none; color: inherit;">
          <div style="border: 1px solid #eee; border-radius: 15px; overflow: hidden; background: white;">
            <Image 
              src={v.imagen_url} 
              alt={v.nombre} 
              width={400} 
              height={250} 
              style="width: 100%; height: 200px; object-fit: cover;"
            />
            <div style="padding: 20px;">
              <span style="font-size: 0.7rem; font-weight: bold; color: #f59e0b; text-transform: uppercase;">
                {v.categoria}
              </span>
              <h2 style="margin: 10px 0; font-size: 1.25rem;">{v.nombre}</h2>
              <p style="font-weight: 900; font-size: 1.1rem; color: #111;">
                {v.precio ? `$${Number(v.precio).toLocaleString()}` : "Consultar"}
              </p>
            </div>
          </div>
        </a>
      ))}
    </div>

    {!hayError && listaVehiculos.length === 0 && (
      <p style="text-align: center; color: #999;">No hay vehículos registrados.</p>
    )}
  </main>
</Layout>